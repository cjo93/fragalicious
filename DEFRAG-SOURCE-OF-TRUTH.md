# DEFRAG: THE UNIVERSAL CHARTER
# Single Source of Truth (SSOT) v27.0
# Architect: Chad Owen | Authority: Divine, Universal & Natural
# Date: February 14, 2026

---

## 1. PREAMBLE: The Return to Nature
We hold these truths to be simple, sacred, and self-evident:
- **Nature Makes No Mistakes:** A bird is not "broken" because it cannot swim, and a fish is not "lazy" because it cannot fly. Every human being is designed with a specific operational purpose. Difference is essential.
- **The Right to Be You:** To force a person to live against their nature is the root of all exhaustion. You have the divine right to operate exactly as you were built.
- **Mission:** To provide a simple translation tool that restores peace by revealing the Natural Design of every individual, stripping away the judgment of "right" and "wrong."

---

## 2. THE THREE NATURAL LAWS
- **Law I: The Law of Energy (Respecting the Engine):** Some people possess a Solar Engine (consistent, generative energy), others a Lunar Engine (variable, receptive energy). We identify your engine type so you can stop apologizing for your natural rhythm.
- **Law II: The Law of Boundaries (Respecting the Fence):** You absorb energy from the world. If you have "Open Windows" (Open Centers), you feel others' emotions as your own. We show you where your windows are, so you know when to close them.
- **Law III: The Law of Momentum (Respecting the Rhythm):** Struggle happens when we force outcomes against our design. Success happens when we act at the right time. We give you a personal Operational Schedule so you know when to push and when to wait.

---

## 3. THE UNIVERSAL TRANSLATION (Role Mapping)
| Technical Label | Natural Role | Simple Truth |
|-----------------|-------------|--------------|
| Projector       | Guide       | The Lighthouse. Built to see, focus, and direct. Needs to be invited to shine, or the light blinds people. |
| Generator       | Builder     | The Engine. Built with a massive battery to create and sustain. Thrives when doing work they love; burns out when bored. |
| Manifestor      | Initiator   | The Spark. Built to start the fire and clear the path. Needs freedom to move without asking for permission. |
| Reflector       | Mirror      | The Moon. Built to reflect the health of the environment. Sensitive to the space they are in. |
| Conditioning    | Mask        | The heavy costume we wear to please our family or society. |
| Authority       | Compass     | The internal sense (Gut, Instinct, Patience) that points to your true north. |

---

## 4. THE MATHEMATICS OF DESIGN
- **Triangulation:** We cross-reference three ancient systems (Planetary Physics, Natural Rhythms, Energetic Mechanics) to find the Pattern that Repeats.
- **Noon-Stable Protocol:** Even without a birth time, the Sun and major planets remain stable for 24 hours. We focus on the stable data, giving you the 80% that is undeniably true.
- **Lineage Logic:** Friction is often inherited. We can layer up to 10 generations to identify "Load-Bearing" patterns and mathematically prove where a behavior entered the family bloodline.

---

## 5. THE PHYSICS OF PERCEPTION (Resistance vs. Flow)
| The Resistance (Signal) | The Mechanical Cause | The Adjustment (Correction) | The Natural Flow (Result) |
|------------------------|---------------------|----------------------------|--------------------------|
| Bitterness             | Guide forcing light into a closed room | Wait for the Window. Stop speaking. Wait for the invitation. | Wisdom (Your words land with weight) |
| Frustration            | Builder forcing a task with no energy  | Check the Tank. Stop the task. Wait for something to respond to. | Mastery (Endless, satisfying energy) |
| Anger                  | Initiator being slowed down or controlled | Inform the Path. Tell them where you are going before you move. | Peace (Freedom of movement) |
| Disappointment         | Mirror trying to hold onto a temporary feeling | Wait for the Moon. Do not identify with the emotion. Let it pass. | Surprise (Seeing the awe in the world) |

---

## 6. THE MECHANICAL PIVOT (Interpersonal Mapping)
| If You Are A... | And You Talk To... | The Friction Is... | The Pivot (Correction) |
|----------------|--------------------|--------------------|-----------------------|
| Guide          | Builder            | You try to direct them while they are working. You feel Bitter. | Stop Speaking. Ask a Yes/No question to engage their engine. |
| Builder        | Guide              | You try to use them for labor. They are exhausted. You feel Frustrated. | Ask for Focus, not Work. "Can you look at this plan?" |
| Initiator      | Builder            | You move fast; they move steady. You feel Angry at slowness. | Inform First. "I am going to do X now." |
| Guide          | Initiator          | You offer advice; they ignore you. You feel Invisible. | Step Back. Let them initiate. |

---

## 7. DAILY RHYTHM (Living the Design)
- **Guide (Projector):**
  - Morning: Slow start. Do not check email immediately. Clear previous day's energy.
  - Work: Focus on study/systems until an invitation comes. Do not chase the meeting; prepare for it.
  - Evening: Discharge the day. Sleep alone or decompress for 30 minutes before bed.
- **Builder (Generator):**
  - Morning: Wake up and move. Burn energy (workout/movement).
  - Work: Respond to what is in front of you. Do the task that lights you up first.
  - Evening: Go until the tank is empty. Sleep best when physically used up.
- **Initiator (Manifestor):**
  - Morning: Check your "Urge." Move if it's there; rest if not.
  - Work: Inform your team of your plan, then execute. Do not ask for permission; ask for clearance.
  - Evening: Disconnect completely. You need solitude to untangle your aura from others.

---

## 8. UTILITY ECOSYSTEM (Monetization Flow)
- **Snapshot (Free):** Validates the user's experience and suffering.
- **Operating System (Core Product):** Secure, mobile-first Dashboard (PWA). Tier 1: Single User. Tier 2: Dual Core (run friction reports with a "Target").
- **Deep Dive (Premium):** Map the invisible friction across 5 generations. Interactive "Circuit Board" of the family tree, highlighting "Load-Bearing" ancestors and trauma loops.

---

## 9. STEWARDSHIP OF THE FUTURE (For Children)
- Every child is born knowing who they are. We help parents protect that knowledge. The result: A child who grows up knowing their own strength, without needing to "de-frag" as an adult.

---

## 10. THE VOICE OF DEFRAG (Hero Positioning & Copy Assets)
- **One-Liners:**
  - "You aren't broken. You're just a Ferrari trying to plow a field."
  - "Your exhaustion is a notification. Read it."
  - "The manual you wished you were born with."
  - "Stop fixing yourself. Start operating yourself."
- **Elevator Pitch:**
  - "Most of us spend our lives trying to be someone else to please our boss or our family. We tell fish to climb trees and then call them lazy when they can't. DEFRAG uses natural laws to show you exactly how your energy works, so you can stop swimming upstream and finally rest."
- **Social Media Bio:**
  - "Restoring the natural design of the human soul. Get your manual ðŸ‘‡"
  - "Peace is just physics. Architect of DEFRAG."

---

## 11. REPRODUCTION PROTOCOL (AI & Style Guide)
- **Master Prompt:**
  - "Act as the Architect of DEFRAG. Your tone is 'Divine Structuralism'â€”authoritative, compassionate, and grounded in natural law. Do not use woo-woo jargon. Use grounded analogies (batteries, gravity) to explain concepts simply. Rules: Reframe their 'flaw' as a 'feature' (e.g., Laziness = Recharging). Use the 'Universal Translation' terms (Guide, Builder, Initiator, Mirror). Keep sentences short and punchy. End with a message of permission/relief."

---

## 12. VISUAL ARCHITECTURE (The Aesthetic of Truth)
- **Palette:** Deep Charcoal (Void), Paper White (Clarity), Warm Gold (Spark), Forest Green (Law).
- **Interface:** "Glass and Steel." High contrast, thin lines, data-dense but uncluttered.
- **Typography:** Bold Sans-Serif (Headlines) + Legible Serif (Body).

---

## 13. THE LIBRARY OF SCRIPTS (Peace Protocols)
- **Overwhelmed:** "I want to hear you, but my battery is red-lining right now. If we keep talking, I won't be listening; I'll be defending. Can we pause for 30 minutes so I can recharge and actually hear you?"
- **Boundary:** "I know this is important to you. However, my capacity works differently. I can offer you my focus on [Small Task A], but I cannot carry the load of the entire project. If I try, the quality of the work will fail."
- **Emergency Eject:** "I am stepping out of this conversation because it is no longer productive. I am not walking away from you; I am walking away from the conflict to protect the relationship. I will return when the energy has settled."
- **Preservation:** "I can feel that you are going through a lot, and I honor that. I can offer you 10 minutes of listening, but then I have to return to my work."
- **Not Now:** "I appreciate your perspective, but I am in 'Output Mode' right now, not 'Input Mode.' I need to trust my own compass on this one."
- **Clarity (Reflectors/Open Centers):** "I am feeling something heavy, but I need to checkâ€”is this mine, or is it yours? I'm going to take a walk to clear my system."

---

## 14. OBJECTION HANDLER (Defense)
- **Objection:** "Is this just astrology?"
  - **Response:** "Astrology is a language of symbols. DEFRAG is a system of mechanics. We use the mathematical positions of the planets to measure gravity and time, just like a farmer uses the seasons to plant crops."
- **Objection:** "Is this scientific?"
  - **Response:** "It is a predictive logic model based on thousands of years of observation. We don't ask you to believe it as a religion; we ask you to test it as a tool. If the manual accurately describes your life, then the tool works."

---

## 15. THE SEEKERS (Target Audience)
- **Seeker A: The High-Performer**
  - Symptom: Successful on paper, dying inside. Usually a Guide forcing themselves to be a Builder.
  - 2 AM Thought: "I have everything I wanted, so why do I feel like quitting?"
  - Offer: "You are a Ferrari trying to pull a plow. Let's unhitch the plow."
- **Seeker B: The Outlier**
  - Symptom: Labeled "flaky" or "too much." Usually an Initiator or Mirror.
  - 2 AM Thought: "Why can't I just be normal like everyone else?"
  - Offer: "Normal is a setting on a washing machine. You are designed for cycles, not straight lines."
- **Seeker C: The Friction-Fatigued**
  - Symptom: Constant triggering. Love is there, but peace is not.
  - 2 AM Thought: "Why does everything turn into a fight?"
  - Offer: "You are speaking French and he is speaking German. Here is the dictionary."

---

## 16. TECHNICAL ARCHITECTURE (Platform Reality)
- **Mobile-First PWA:** Functions as a native app on iOS/Android (Next.js + Tailwind). Designed for "Pocket Intelligence."
- **Command Center:** Secure dashboard for profiles, friction reports, generational trees.
- **AI Core:** Secure AI synthesizes raw mechanical data into natural language reports. Input: Birth coordinates. Calculation: Python engine using NASA-grade ephemeris. Logic Layer: Applies "Natural Law" rules. Hybrid Compute: Noon-Stable fallback for missing times.
- **Data Model & Schema:**
  - **Human Design Gates (`hd_gates`)**
    - 64 gates of the RAV wheel. Fields: gate_number, name, center, circuit, gene_key_id.
  - **Gene Keys (`gene_keys`)**
    - 64 Gene Keys and their frequency bands. Fields: key_number, shadow, gift, siddhi, programming_partner, codon_group.
  - **Astrological Natal Charts (`natal_charts`)**
    - High-fidelity planetary positions. Fields: id, user_id, birth_data, planetary_positions, calculated_at.
  - **Family Nodes (`family_nodes`)**
    - Individual units in a genogram. Fields: id, user_id, label, type, trait_id, mechanics_cache.
  - **Family Edges (`family_edges`)**
    - "Friction Vectors" and "Recursive Loops". Fields: id, source_node_id, target_node_id, interaction_type, is_recursive, metadata.
- **API Contract:**
  - **POST /chat**
    - SSE stream for chat, tool calls, and error events. Accepts user input, context (user_id, session_id, current_transits, family_context, user_mechanics). Returns streamed JSON: text, tool_call, error, done.
  - **GET /transits/check**
    - Returns current planetary "weather" (status, mechanic, orb, velocity, intensity_score, guidance, technical_data).
  - **POST /stripe/portal**
    - Stripe session for subscriptions. Webhooks update Supabase profiles.
- **Deployment & Environment:**
  - Frontend: Vercel.
  - Backend: Railway/Render.
  - Database: Supabase cloud.
  - Environment variables: .env (never committed).

---

## 17. USER JOURNEY (Roadmap to Sovereignty)
- **Phase 1: The Instant Exhale (Minute 0):** User reads the Snapshot, feels seen, stress evaporates.
- **Phase 2: The Detox (Day 1-30):** User notices "Energy Leaks." Sets boundaries using Peace Protocols. Reclaims energy.
- **Phase 3: The Sovereignty (Day 30+):** User moves with confidence. Navigates conflict using leverage, not force. A life that powers itself.

---

## 18. LAUNCH PROTOCOL & API STRATEGY
- **Lighthouse Phase:** Post One-Liners. Drive traffic to defrag.app for the free Snapshot.
- **Command Center Phase:** Sell the "Operating Manual" ($27) directly on the site. Immediate access to Dashboard (PWA).
- **API Ecosystem:** api.defrag.app is the brain. defrag.app is the face. Allow other platforms to call the DEFRAG engine. Internal: Free for defrag.app. External: Credit-Based Pricing.
- **Scaling:** Stateless, on-demand calculation. Handles 1 or 1 million requests with the same architecture.

---

## 19. LEGAL & LIABILITY (The Safety Fence)
- **Disclaimer:** "DEFRAG is a system for self-discovery and energetic alignment. It is not a substitute for clinical therapy, medical diagnosis, or legal advice."
- **Free Will:** "The blueprints are maps, not mandates. The user retains full sovereignty."
- **Privacy:** "We treat your data as sacred. We do not sell your blueprint."

---

## 20. THE EVOLUTION ROADMAP (Future State)
- **Mobile Command Center:** Native iOS/Android for daily energy tracking.
- **API Ecosystem:** Licensing the engine to high-volume partners.
- **Enterprise:** "Equipment Specs" for HR departments to prevent burnout.

---

## 21. ONBOARDING
- **How to Use This Document:**
  - This file is the **only** source of truth for the DEFRAG project. All technical, narrative, and design decisions must reference this document first.
  - Read this file top to bottom. Build, test, and write code using only the definitions, rules, and templates here. Update this file first for any system changes. Do not reference or rely on any other documentation.
  - For new contributors: This file replaces all other onboarding, API, or design docs. All system logic, phrasing, and technical details are here.

---

## 22. PLATFORM CONTEXT & ENGINEERING HANDOVER

### Mission & Context
DEFRAG is a mobile-first Progressive Web App (PWA) and Intelligence Platformâ€”an "Operating System for Human Design" using planetary mechanics (Astrology/Human Design) and Bowen Family Systems Theory to generate non-esoteric, physics-based user manuals for life and relationships. The mission is to build a secure, scalable platform where users input birth data and receive immediate, high-value architectural blueprints of their personality and relationship dynamics.

### Strict Tech Stack
- **Framework:** Next.js 14+ (App Router)
- **Frontend Language:** TypeScript
- **Backend Calculation Engine:** Python
- **Styling:** Tailwind CSS (Mobile-First, "Glass & Steel" aesthetic)
- **Database:** Supabase (PostgreSQL)
- **Auth:** Supabase Auth
- **Hosting/Edge:** Vercel (Frontend), Vercel Python Runtime or Modal.com (Backend Calculation)
- **Version Control:** GitHub
- **Payments:** Stripe (Credits Model)

### Database Schema (Supabase/PostgreSQL)
- **profiles:** id (UUID, PK, linked to auth.users), email, credits_balance, stripe_customer_id, subscription_tier
- **charts:** id, user_id, name, birth_data (JSONB), time_fidelity (Enum: 'EXACT', 'NOON_STABLE'), raw_mechanics (JSONB), natural_law_profile (JSONB)
- **connections:** id, chart_id_a, chart_id_b, relationship_type (Enum), bowen_attributes (JSONB), friction_report (JSONB)
- **lineage_nodes:** id, root_user_id, generation_index, parent_node_id, inherited_traits (JSONB)

### Calculation Engine (Python Microservice)
- Hosted as a Vercel Serverless Function or Modal.com container (for pyswisseph C-bindings).
- **Module A:** Physics Engine (/calculate)
  - Input: date, time, lat, long
  - Noon-Stable Protocol: If time is None, set to Noon, mask Moon/ASC, mark profile as PARTIAL
  - Output: JSON with Gate activations and Line data
- **Module B:** PDF Generator (/generate-pdf)
  - Library: WeasyPrint (Python)
  - Deployment: Requires Linux binaries (libpango). Use custom Buildpack or Docker container if needed.
  - Style: Dark background (#1a1a1a), White/Gold lines, Monospaced fonts

### AI Synthesis Layer (Vercel AI SDK)
- The AI is the "Translator," not the "Author." It translates Math â†’ Natural Law.
- **Safety & Guardrails:**
  - Input Scan: Abort and return static JSON if crisis keywords detected
  - Medical Filter: Never output "Cure," "Diagnosis," "Treat"
- **Prompt Engineering:**
  - Model: Gemini 1.5 Pro or GPT-4o
  - Temperature: 0.2
  - System Prompt: "You are the Architect of DEFRAG. You analyze raw mechanical data provided in the JSON. You translate it into the 'Voice of Natural Law.' Use functional terms, not esoteric. Frame 'Shadows' as 'Resistance' and 'Gifts' as 'Flow'. Use analogies of Engines, Lighthouses, and Sparks. Bowen Systems: Identify 'Triangles' and 'Cutoffs' from connection data."

### API Route Structure & Monetization
- **Credit System:** Snapshot: 0 Credits, Full Manual: 10 Credits, Root Analysis: 50 Credits
- **Endpoints:**
  - POST /api/engine/snapshot: Public, returns partial JSON
  - POST /api/engine/full-report: Protected, decrements credits, triggers Python Engine + AI Synthesis, returns PDF URL
  - POST /api/lineage/trace: Protected, recursive, returns "Root Cause" schematic
  - POST /api/payments/webhook: Stripe webhook listener, increments credits_balance

### UI/UX Directives (Visual Architecture)
- **Command Center Dashboard:** Mobile First, bottom nav bar, "Energy Status" visible on login
- **Visual Style:** "Glass and Steel" (bg-slate-900, border-white/10)
- **Typography:** Inter (Headers), Merriweather (Body)
- **Generational Map (Bowen View):**
  - Library: React Flow or VisX
  - Males: Squares, Females: Circles
  - Edges: Solid = Flow, Jagged = Friction, Dashed = Cutoff, Double = Fusion
  - Node click: Show "Engine Type" and lineage impact

### Critical Code Logic (SQL & Config)
- **Recursive Family Tree Fetch (Supabase SQL):**
```sql
WITH RECURSIVE family_tree AS (
  SELECT id, root_user_id, generation_index, inherited_traits, parent_node_id
  FROM lineage_nodes
  WHERE root_user_id = 'USER_UUID' AND generation_index = 0
  UNION ALL
  SELECT c.id, c.root_user_id, c.generation_index, c.inherited_traits, c.parent_node_id
  FROM lineage_nodes c
  INNER JOIN family_tree p ON p.parent_node_id = c.id
)
SELECT * FROM family_tree;
```
- **Vercel Config (vercel.json) for Python:**
```json
{
  "builds": [
    {
      "src": "api/index.py",
      "use": "@vercel/python",
      "config": { "maxDuration": 30 }
    }
  ]
}
```

### Immediate Build Steps
1. `npx create-next-app@latest` with Tailwind
2. Set up Supabase project and apply SQL Schema
3. Deploy Python calculate function (test pyswisseph early; if Vercel fails, use Modal.com)
4. Build the "Blind Read" input form using the Snapshot endpoint

---

## 23. TECHNICAL ADDENDUM (The Final 5%)

This section resolves the 10 critical engineering clarifications. Use this in conjunction with the SSOT and IDE Agent Handover for a hermetically sealed build.

### 1. SWISS EPHEMERIS LOGIC (Specific Implementation)
- Use pyswisseph (swe) for all planetary calculations.
- Calculation Module (api/engine/calc.py):
```python
import swisseph as swe
import os
# Set Ephemeris Path (Must be included in Docker/Vercel build)
ephe_path = os.path.join(os.path.dirname(__file__), 'ephe')
swe.set_ephe_path(ephe_path)

def get_body_position(julian_day, body_id):
    flags = swe.FLG_SWIEPH | swe.FLG_SPEED
    result, flag = swe.calc_ut(julian_day, body_id, flags)
    return {
        "longitude": result[0],
        "gate": int((result[0] / 360) * 64) + 1,
        "line": int(((result[0] / 360) * 64 * 6) % 6) + 1
    }

def calculate_chart(date, time_utc, lat, lon):
    # Convert DateTime to Julian Day
    jd = swe.julday(year, month, day, hour + minute/60.0)
    mechanics = {
        "sun": get_body_position(jd, 0),
        "earth": get_body_position(jd, 0), # Earth is opposite Sun
        # ... other planets
    }
    mechanics['earth']['longitude'] = (mechanics['sun']['longitude'] + 180) % 360
    return mechanics
```

### 2. PDF GENERATION (Async Pattern)
- Use Modal.com for async PDF jobs. WeasyPrint runs in a container, not in Next.js API.
- Flow: Next.js API triggers Modal webhook, returns job_id, frontend polls for completion.
- Modal Function Example:
```python
@stub.function(image=image)
@web_endpoint(method="POST")
def generate_pdf(data: dict):
    from weasyprint import HTML
    html = render_template("user_manual.html", data=data)
    pdf = HTML(string=html).write_pdf()
    url = supabase.storage.from_("reports").upload(f"{data['user_id']}.pdf", pdf)
    return {"status": "success", "url": url}
```

### 3. ENGINE LOADER INTEGRATION
- The EngineLoader is triggered for both Snapshot and Full Report.
- UX: Full-screen overlay, black background, gold animation, cycles through value-adding messages, then fades out to reveal dashboard.

### 4. CUSTOM EDGES (Fusion & Enmeshment)
- Add FusionEdge to React Flow for "over-connection" (double gold line effect):
```typescript
export function FusionEdge({ id, sourceX, sourceY, targetX, targetY }: EdgeProps) {
  const [edgePath] = getSmoothStepPath({ sourceX, sourceY, targetX, targetY });
  return (
    <>
      <BaseEdge path={edgePath} style={{ stroke: '#D4AF37', strokeWidth: 4 }} />
      <BaseEdge path={edgePath} style={{ stroke: '#0F172A', strokeWidth: 2 }} />
      <text>
        <textPath href={`#${id}`} startOffset="50%" textAnchor="middle" className="fill-gold-500 text-xs tracking-widest">
          FUSION
        </textPath>
      </text>
    </>
  );
}
```

### 5. STRIPE WEBHOOK SECURITY
- Always verify Stripe webhook signatures.
- Example (app/api/payments/webhook/route.ts):
```typescript
import { stripe } from '@/lib/stripe';
import { headers } from 'next/headers';
export async function POST(req: Request) {
  const body = await req.text();
  const signature = headers().get('Stripe-Signature') as string;
  try {
    const event = stripe.webhooks.constructEvent(
      body,
      signature,
      process.env.STRIPE_WEBHOOK_SECRET!
    );
    if (event.type === 'checkout.session.completed') {
      await addCredits(event.data.object.metadata.userId);
    }
  } catch (err) {
    return new Response(`Webhook Error: ${err.message}`, { status: 400 });
  }
}
```

### 6. AI MODEL SELECTION
- Use environment variables for model/provider selection.
- .env.local:
```
AI_MODEL_PROVIDER="openai" # or "google"
AI_MODEL_VERSION="gpt-4o" # or "gemini-1.5-pro"
```
- The AIService class reads these to select the SDK adapter.

### 7. USER ROLES (RBAC)
- Add `role` column to profiles: text default 'USER' check (role in ('USER', 'ADMIN', 'ARCHITECT')).
- RLS Policy:
```sql
create policy "Admins can view all" on profiles for select using (auth.jwt() ->> 'role' = 'ADMIN');
```

### 8. MOBILE RESPONSIVENESS
- Buttons: min-h-[44px] min-w-[44px] (Apple guideline).
- Inputs: text-16px (prevents iOS zoom).
- Use framer-motion for swipe gestures on friction reports.

### 9. DATA DELETION (GDPR/Trust)
- User-facing "Hard Delete" button in Settings.
- Supabase RPC:
```sql
create or replace function delete_user_account() returns void as $$
begin
  delete from auth.users where id = auth.uid();
end;
$$ language plpgsql security definer;
```

### 10. TESTING & QA (Critical Path)
- Backend: tests/test_noon_stable.py must ensure Moon is "UNCERTAIN" if time is None.
- Frontend: tests/purchase_flow.spec.ts must verify Stripe flow, credit increment, and report generation.

---
# This file is the single source of truth for DEFRAG. All phrasing, positioning, technical, and AI/agent decisions must reference this document first.
# Update this file with any new architectural, narrative, or API changes.
